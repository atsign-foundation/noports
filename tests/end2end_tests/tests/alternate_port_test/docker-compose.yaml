version: '3'
networks:
  sshnp:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnp
  sshnpd:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnpd
services:
  image-runtime-local:
    build:
      context: ../../../../ # root of the repository
      dockerfile: ./tests/end2end_tests/image/Dockerfile
      target: runtime-local
    image: atsigncompany/sshnp-e2e-runtime:local
    deploy:
      mode: replicated
      replicas: 0
  container-sshnp:
    container_name: sshnp
    volumes:
      - ../../contexts/sshnp:/mount
    networks:
      - sshnp
    image: atsigncompany/sshnp-e2e-runtime:local
    depends_on:
      - image-runtime-local
      - container-sshnpd
  container-sshnpd:
    container_name: sshnpd
    volumes:
      - ../../contexts/sshnpd:/mount
    networks:
      - sshnpd
    image: atsigncompany/sshnp-e2e-runtime:local
    depends_on:
      - image-runtime-local
    healthcheck:
      test: ["CMD", "grep", "-Eq", "monitor started for @", "/atsign/err.txt"]
      start_period: 10s # Wait 10 seconds before checking
      interval: 5s # Check every 5 seconds
      timeout: 1s # If a check takes longer than a second, consider it a failed check
      retries: 180 # Retry the check 180 times (180 * 5s = 15 mins)
