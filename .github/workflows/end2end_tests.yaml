name: end2end_tests

on:
  workflow_dispatch:
  push:
    branches:
      - trunk
  pull_request:
    branches:
      - trunk

env:
  SSHNP_ATSIGN: "@jeremy_0"
  SSHNPD_ATSIGN: "@smoothalligator"

jobs:
  end2end_tests_trunk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3

      - name: View files
        working-directory: packages/sshnoports
        run: |
          ls -la
          pwd

      - name: Copy keys
        working-directory: packages/sshnoports/test/end2end_tests/context
        run: |
          echo "${{ secrets.JEREMY_0_KEY }}" > sshnp/keys/${{ env.SSHNP_ATSIGN }}_key.atKeys
          echo "${{ secrets.SMOOTHALLIGATOR_KEY }}" > sshnpd/keys/${{ env.SSHNPD_ATSIGN }}_key.atKeys

      - name: Ensure keys are in place
        working-directory: packages/sshnoports/test/end2end_tests/context
        run: |
          ls sshnp/keys
          ls sshnpd/keys

      - name: Docker Compose
        working-directory: packages/sshnoports/test/end2end_tests
        run: |
          docker-compose up

      - name: View containers
        run: |
          docker ps -a
