name: end2end_tests

on:
  workflow_dispatch:
  push:
    branches:
      - trunk
  pull_request:
    branches:
      - trunk

jobs:
  # docker_hub:
  #   runs-on: ubuntu-latest
  #   steps:
  #     # login to docker
  #     - name: Set up QEMU
  #       uses: docker/setup-qemu-action@2b82ce82d56a2a04d2637cd93a637ae1b359c0a7 # v2.2.0

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@ecf95283f03858871ff00b787d79c419715afc34 # v2.7.0

  #     - name: Login to DockerHub
  #       uses: docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc # v2.2.0
  #       with:
  #         username: ${{ secrets.DOCKER_USERNAME }}
  #         password: ${{ secrets.DOCKER_PASSWORD }}

  #     - name: Checkout
  #       uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3

  #     - name: Build and push
  #       id: docker_build
  #       uses: docker/build-push-action@2eb1c1961a95fc15694676618e422e8ba1d63825 # v4.1.1
  #       with:
  #         file: test/end2end_tests/sshnpd_image/Dockerfile
  #         context: .
  #         push: true
  #         tags: |
  #           x23mark/end2end_tests_sshnpd:latest
  #         platforms: |
  #           linux/amd64
  #           linux/arm64/v8

  setup_sshnpd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3

      - name: View files
        run: ls -la

      - name: Copy keys
        run: echo "${{secrets.SOCCER0_KEY}}" > @soccer0_key.atKeys
        working-directory: test/end2end_tests/sshnpd_image/keys

      - name: Build Docker container
        run: |
          docker build -t end2end_tests_sshnpd:latest -f test/end2end_tests/sshnpd_image/Dockerfile .

      - name: Run Docker container
        uses: addnab/docker-run-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.io
          image: end2end_tests_sshnpd:latest
          run: |
            echo "Running Docker Container"

  end2end_tests:
    runs-on: ubuntu-latest
    needs: [setup_sshnpd]
    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
      - uses: dart-lang/setup-dart@d6a63dab3335f427404425de0fbfed4686d93c4f # v1.5.0
        with:
          sdk: stable

      # Install dependencies in sshnoports
      - name: Install dependencies in sshnoports
        working-directory: .
        run: dart pub get

      # Install dependencies in end2end_tests
      - name: Install dependencies in test/end2end_tests
        working-directory: test/end2end_tests
        run: dart pub get

      # Run end2end_tests
      - name: Run end2end_tests
        working-directory: test/end2end_tests
        run: dart test .
