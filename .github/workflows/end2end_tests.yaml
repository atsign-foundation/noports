name: end2end_tests

on:
  workflow_dispatch:
  push:
    branches:
      - trunk
  pull_request:
    branches:
      - trunk

jobs:
  end2end_tests_trunk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3

      - name: View files
        run: |
          ls -la
          pwd

      - name: Copy keys
        working-directory: test/end2end_tests/context
        run: |
          echo "${{ secrets.JEREMY_0_KEY }}" > sshnp/keys/@jeremy_0.atKeys
          echo "${{ secrets.SMOOTHALLIGATOR_KEY }}" > sshnpd/keys/@smoothalligator.atKeys

      - name: Build Base Image
        working-directory: test/end2end_tests
        run: docker build -t atsigncompany/sshnp-e2e-base -f images/base/Dockerfile images/base

      - name: Build Sshnp & Sshnpd Trunk Images
        working-directory: test/end2end_tests
        run: |
          docker build -t atsigncompany/sshnp-e2e-sshnp-trunk -f images/trunk/Dockerfile context/sshnp
          docker build -t atsigncompany/sshnp-e2e-sshnpd-trunk -f images/trunk/Dockerfile context/sshnpd

      - name: Run Sshnpd Trunk
        working-directory: test/end2end_tests
        run: |
          docker run \
            -t \
            --name sshnp-e2e-trunk-sshnpd \
            atsigncompany/sshnp-e2e-trunk
          echo $?

      - name: Run Sshnp Trunk
        working-directory: test/end2end_tests
        run: |
          docker run \
            -t \
            --name sshnp-e2e-trunk-sshnp \
            atsigncompany/sshnp-e2e-trunk
          echo $?

      - name: View containers
        run: |
          docker ps -a


  # attempting to use `dart test `
  # end2end_tests:
  #   runs-on: ubuntu-latest
  #   needs: [setup_sshnpd]
  #   steps:
  #     - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
  #     - uses: dart-lang/setup-dart@d6a63dab3335f427404425de0fbfed4686d93c4f # v1.5.0
  #       with:
  #         sdk: stable

  #     # Install dependencies in sshnoports
  #     - name: Install dependencies in sshnoports
  #       working-directory: .
  #       run: dart pub get

  #     # Install dependencies in end2end_tests
  #     - name: Install dependencies in test/end2end_tests
  #       working-directory: test/end2end_tests
  #       run: dart pub get

  #     # Set up ssh keys
  #     - name: Set up ssh keys
  #       run: ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -q

  #     # Run end2end_tests
  #     - name: Run end2end_tests
  #       working-directory: test/end2end_tests
  #       run: |
  #         mkdir -p ~/.atsign/keys
  #         echo "${{ secrets.JEREMY_0_KEY }}" > ~/.atsign/@jeremy_0_key.atKeys
  #         dart test .
