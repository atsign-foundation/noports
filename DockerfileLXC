FROM alpine AS buildimage
ENV BINARYDIR=/usr/local/at
#SHELL ["/bin/ash", "-c"]
# WORKDIR /app
# COPY . .
# RUN \
#   #set -eux ; \
#   apk add dart --repository=http://dl-cdn.alpinelinux.org/alpine/edge ;\
#   apk add --no-cache dhclient openssh bash sudo file iputils ;\
#   mkdir -p ${BINARYDIR} ; \
#   dart pub get ; \
#   dart pub update ; \
#   dart compile exe bin/sshnpd.dart -o ${BINARYDIR}/sshnpd

# # Second stage of build FROM debian-slim
FROM alpine
WORKDIR /app
COPY . .
ENV HOMEDIR=/atsign
ENV USER_ID=1024
ENV GROUP_ID=1024
RUN apk add --no-cache dhclient openssh bash sudo file iputils curl;\
   apk add dart --repository=http://dl-cdn.alpinelinux.org/alpine/edge/testing/ ; \
   echo "sshnpd" > /etc/hostname ; \
   addgroup -g $GROUP_ID atsign ; \
   adduser -S -h $HOMEDIR -s /bin/bash -G atsign -u $USER_ID atsign ; \
   sed -i s/atsign:!/"atsign:*"/g /etc/shadow ; \
   mkdir -p $HOMEDIR/.atsign/keys ; \
   mkdir -p $HOMEDIR/.ssh ; \
   touch $HOMEDIR/.ssh/authorized_keys ; \
   chown -R atsign:atsign $HOMEDIR ; \
   chown -R atsign:atsign /app ; \
   chmod 600 $HOMEDIR/.ssh/authorized_keys ; \
   usermod -aG sudo atsign ; \
   mkdir /run/sshd ; \
   cp /app/.startupLXC.sh /atsign ;\
   chmod 755 /atsign/.startupLXC.sh
WORKDIR /atsign
# USER atsign 
ENTRYPOINT ["/atsign/.startupLXC.sh"]
