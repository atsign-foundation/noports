version: '3'

services:
  image-runtime-trunk:
    build:
      context: ./image/
      dockerfile: ./Dockerfile
      target: runtime-branch
      args:
        - branch=trunk
    image: atsigncompany/sshnp-e2e-runtime:branch-trunk
    deploy:
      mode: replicated
      replicas: 0
  container-trunk-sshnpd:
    image: atsigncompany/sshnp-e2e-runtime:branch-trunk
    container_name: sshnpd_trunk
    volumes:
      - sshnpd-keys:/atsign/.atsign/keys/ # mount keys
      - sshnpd-entrypoint:/atsign/entrypoint.sh # mount entrypoint
    networks:
      - sshnpd
    depends_on:
      - image-runtime-trunk
  container-trunk-sshnp:
    image: atsigncompany/sshnp-e2e-runtime:branch-trunk
    container_name: sshnp_trunk
    volumes:
      - sshnp-keys:/atsign/.atsign/keys/ # mount keys
      - sshnp-entrypoint:/atsign/entrypoint.sh # mount entrypoint
    networks:
      - sshnp
    depends_on:
      - image-runtime-trunk
      - container-trunk-sshnpd

networks:
  sshnp:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnp
  sshnpd:
    driver: bridge
    name: atsigncompany/sshnp-e2e-network-sshnpd

volumes:
  sshnpd-keys:
    name: sshnpd-keys
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./context/sshnpd/keys/
  sshnpd-entrypoint:
    name: sshnpd-entrypoint
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./context/sshnpd/entrypoint.sh
  sshnp-keys:
    name: sshnp-keys
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./context/sshnp/keys/
  sshnp-entrypoint:
    name: sshnp-entrypoint
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./context/sshnp/entrypoint.sh
